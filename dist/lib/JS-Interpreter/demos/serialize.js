/**
 * @license
 * JavaScript Interpreter: serialization and deserialization
 *
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/**
 * @fileoverview Saving and restoring the state of a JS-Intepreter.
 * @author fraser@google.com (Neil Fraser)
 */
'use strict';

require("core-js/modules/es.symbol");

require("core-js/modules/es.symbol.description");

require("core-js/modules/es.symbol.iterator");

require("core-js/modules/es.array.index-of");

require("core-js/modules/es.array.is-array");

require("core-js/modules/es.array.iterator");

require("core-js/modules/es.array.map");

require("core-js/modules/es.date.to-json");

require("core-js/modules/es.date.to-string");

require("core-js/modules/es.number.constructor");

require("core-js/modules/es.object.create");

require("core-js/modules/es.object.define-property");

require("core-js/modules/es.object.get-own-property-descriptor");

require("core-js/modules/es.object.get-own-property-names");

require("core-js/modules/es.object.get-prototype-of");

require("core-js/modules/es.object.to-string");

require("core-js/modules/es.regexp.constructor");

require("core-js/modules/es.regexp.exec");

require("core-js/modules/es.regexp.flags");

require("core-js/modules/es.regexp.to-string");

require("core-js/modules/es.string.iterator");

require("core-js/modules/web.dom-collections.iterator");

require("core-js/modules/web.url.to-json");

function _typeof(obj) { if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

function deserialize(json, interpreter) {
  function decodeValue(value) {
    if (value && _typeof(value) === 'object') {
      var data;

      if (data = value['#']) {
        value = objectList[data];

        if (!value) {
          throw ReferenceError('Object reference not found: ' + data);
        }

        return value;
      }

      if (data = value['Number']) {
        return Number(data);
      }

      if (data = value['Value']) {
        if (value['Value'] === 'undefined') {
          return undefined;
        }
      }
    }

    return value;
  }

  var stack = interpreter.stateStack;

  if (!Array.isArray(json)) {
    throw TypeError('Top-level JSON is not a list.');
  }

  if (!stack.length) {
    throw Error('Interpreter must be initialized prior to deserialization.');
  }

  var objectList = [];
  objectHunt_(stack, objectList);
  var functionHash = Object.create(null);

  for (var i = 0; i < objectList.length; i++) {
    if (typeof objectList[i] == 'function') {
      functionHash[objectList[i].id] = objectList[i];
    }
  }

  objectList = [];

  for (var i = 0; i < json.length; i++) {
    var jsonObj = json[i];
    var obj;

    switch (jsonObj['type']) {
      case 'Map':
        obj = Object.create(null);
        break;

      case 'Object':
        obj = {};
        break;

      case 'ScopeReference':
        obj = Interpreter.SCOPE_REFERENCE;
        break;

      case 'Function':
        obj = functionHash[jsonObj['id']];

        if (!obj) {
          throw RangeError('Function ID not found: ' + jsonObj['id']);
        }

        break;

      case 'Array':
        obj = [];
        break;

      case 'Date':
        obj = new Date(jsonObj['data']);

        if (isNaN(obj)) {
          throw TypeError('Invalid date: ' + jsonObj['data']);
        }

        break;

      case 'RegExp':
        obj = RegExp(jsonObj['source'], jsonObj['flags']);
        break;

      case 'PseudoObject':
        obj = new Interpreter.Object(null);
        break;

      case 'State':
        obj = new Interpreter.State(undefined, undefined);
        break;

      case 'Node':
        obj = new interpreter.nodeConstructor();
        break;

      default:
        throw TypeError('Unknown type: ' + jsonObj['type']);
    }

    objectList[i] = obj;
  }

  for (var i = 0; i < json.length; i++) {
    var jsonObj = json[i];
    var obj = objectList[i];
    var props = jsonObj['props'];

    if (props) {
      var nonConfigurable = jsonObj['nonConfigurable'] || [];
      var nonEnumerable = jsonObj['nonEnumerable'] || [];
      var nonWritable = jsonObj['nonWritable'] || [];
      var names = Object.getOwnPropertyNames(props);

      for (var j = 0; j < names.length; j++) {
        var name = names[j];
        Object.defineProperty(obj, name, {
          configurable: nonConfigurable.indexOf(name) === -1,
          enumerable: nonEnumerable.indexOf(name) === -1,
          writable: nonWritable.indexOf(name) === -1,
          value: decodeValue(props[name])
        });
      }
    }

    if (Array.isArray(obj)) {
      var data = jsonObj['data'];

      if (data) {
        for (var j = 0; j < data.length; j++) {
          obj.push(decodeValue(data[j]));
        }
      }
    }
  }

  var root = objectList[0];

  for (var prop in root) {
    interpreter[prop] = root[prop];
  }
}

function serialize(interpreter) {
  function encodeValue(value) {
    if (value && (_typeof(value) === 'object' || typeof value === 'function')) {
      var ref = objectList.indexOf(value);

      if (ref === -1) {
        throw RangeError('Object not found in table.');
      }

      return {
        '#': ref
      };
    }

    if (value === undefined) {
      return {
        'Value': 'undefined'
      };
    }

    if (typeof value === 'number') {
      if (value === Infinity) {
        return {
          'Number': 'Infinity'
        };
      } else if (value === -Infinity) {
        return {
          'Number': '-Infinity'
        };
      } else if (isNaN(value)) {
        return {
          'Number': 'NaN'
        };
      } else if (1 / value === -Infinity) {
        return {
          'Number': '-0'
        };
      }
    }

    return value;
  }

  var properties = ['OBJECT', 'OBJECT_PROTO', 'FUNCTION', 'FUNCTION_PROTO', 'ARRAY', 'ARRAY_PROTO', 'REGEXP', 'REGEXP_PROTO', 'BOOLEAN', 'DATE', 'NUMBER', 'STRING', 'ERROR', 'EVAL_ERROR', 'RANGE_ERROR', 'REFERENCE_ERROR', 'SYNTAX_ERROR', 'TYPE_ERROR', 'URI_ERROR', 'global', 'stateStack'];
  var root = Object.create(null);

  for (var i = 0; i < properties.length; i++) {
    root[properties[i]] = interpreter[properties[i]];
  }

  var objectList = [];
  objectHunt_(root, objectList);
  var json = [];

  for (var i = 0; i < objectList.length; i++) {
    var jsonObj = Object.create(null);
    json.push(jsonObj);
    var obj = objectList[i];

    switch (Object.getPrototypeOf(obj)) {
      case null:
        jsonObj['type'] = 'Map';
        break;

      case Object.prototype:
        if (obj === Interpreter.SCOPE_REFERENCE) {
          jsonObj['type'] = 'ScopeReference';
          continue;
        } else {
          jsonObj['type'] = 'Object';
        }

        break;

      case Function.prototype:
        jsonObj['type'] = 'Function';
        jsonObj['id'] = obj.id;

        if (obj.id === undefined) {
          throw Error('Native function has no ID: ' + obj);
        }

        continue;

      case Array.prototype:
        jsonObj['type'] = 'Array';

        if (obj.length) {
          jsonObj['data'] = obj.map(encodeValue);
        }

        continue;

      case Date.prototype:
        jsonObj['type'] = 'Date';
        jsonObj['data'] = obj.toJSON();
        continue;

      case RegExp.prototype:
        jsonObj['type'] = 'RegExp';
        jsonObj['source'] = obj.source;
        jsonObj['flags'] = obj.flags;
        continue;

      case Interpreter.Object.prototype:
        jsonObj['type'] = 'PseudoObject';
        break;

      case Interpreter.State.prototype:
        jsonObj['type'] = 'State';
        break;

      case interpreter.nodeConstructor.prototype:
        jsonObj['type'] = 'Node';
        break;

      default:
        throw TypeError('Unknown type: ' + obj);
    }

    var props = Object.create(null);
    var nonConfigurable = [];
    var nonEnumerable = [];
    var nonWritable = [];
    var names = Object.getOwnPropertyNames(obj);

    for (var j = 0; j < names.length; j++) {
      var name = names[j];
      props[name] = encodeValue(obj[name]);
      var descriptor = Object.getOwnPropertyDescriptor(obj, name);

      if (!descriptor.configurable) {
        nonConfigurable.push(name);
      }

      if (!descriptor.enumerable) {
        nonEnumerable.push(name);
      }

      if (!descriptor.writable) {
        nonWritable.push(name);
      }
    }

    if (names.length) {
      jsonObj['props'] = props;
    }

    if (nonConfigurable.length) {
      jsonObj['nonConfigurable'] = nonConfigurable;
    }

    if (nonEnumerable.length) {
      jsonObj['nonEnumerable'] = nonEnumerable;
    }

    if (nonWritable.length) {
      jsonObj['nonWritable'] = nonWritable;
    }
  }

  return json;
}

function objectHunt_(node, objectList) {
  if (node && (_typeof(node) === 'object' || typeof node === 'function')) {
    if (objectList.indexOf(node) != -1) {
      return;
    }

    objectList.push(node);

    if (_typeof(node) === 'object') {
      var names = Object.getOwnPropertyNames(node);

      for (var i = 0; i < names.length; i++) {
        objectHunt_(node[names[i]], objectList);
      }
    }
  }
}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9KUy1JbnRlcnByZXRlci9kZW1vcy9zZXJpYWxpemUuanMiXSwibmFtZXMiOlsiZGVzZXJpYWxpemUiLCJqc29uIiwiaW50ZXJwcmV0ZXIiLCJkZWNvZGVWYWx1ZSIsInZhbHVlIiwiZGF0YSIsIm9iamVjdExpc3QiLCJSZWZlcmVuY2VFcnJvciIsIk51bWJlciIsInVuZGVmaW5lZCIsInN0YWNrIiwic3RhdGVTdGFjayIsIkFycmF5IiwiaXNBcnJheSIsIlR5cGVFcnJvciIsImxlbmd0aCIsIkVycm9yIiwib2JqZWN0SHVudF8iLCJmdW5jdGlvbkhhc2giLCJPYmplY3QiLCJjcmVhdGUiLCJpIiwiaWQiLCJqc29uT2JqIiwib2JqIiwiSW50ZXJwcmV0ZXIiLCJTQ09QRV9SRUZFUkVOQ0UiLCJSYW5nZUVycm9yIiwiRGF0ZSIsImlzTmFOIiwiUmVnRXhwIiwiU3RhdGUiLCJub2RlQ29uc3RydWN0b3IiLCJwcm9wcyIsIm5vbkNvbmZpZ3VyYWJsZSIsIm5vbkVudW1lcmFibGUiLCJub25Xcml0YWJsZSIsIm5hbWVzIiwiZ2V0T3duUHJvcGVydHlOYW1lcyIsImoiLCJuYW1lIiwiZGVmaW5lUHJvcGVydHkiLCJjb25maWd1cmFibGUiLCJpbmRleE9mIiwiZW51bWVyYWJsZSIsIndyaXRhYmxlIiwicHVzaCIsInJvb3QiLCJwcm9wIiwic2VyaWFsaXplIiwiZW5jb2RlVmFsdWUiLCJyZWYiLCJJbmZpbml0eSIsInByb3BlcnRpZXMiLCJnZXRQcm90b3R5cGVPZiIsInByb3RvdHlwZSIsIkZ1bmN0aW9uIiwibWFwIiwidG9KU09OIiwic291cmNlIiwiZmxhZ3MiLCJkZXNjcmlwdG9yIiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwibm9kZSJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFtQkE7Ozs7QUFJQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFQSxTQUFTQSxXQUFULENB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LElBQUksS0FBSyxRQUFPQSxJQUFQLE1BQWdCLFFBQWhCLElBQTRCLE9BQU9BLElBQVAsS0FBZ0IsVUFBakQsQ0FBUixFQUFzRTtBQUNwRSxRQUFJekQsVUFBVSxDQUFDcUMsT0FBWCxDQUFtQm9CLElBQW5CLEtBQTRCLENBQUMsQ0FBakMsRUFBb0M7QUFDbEM7QUFDRDs7QUFDRHpELElBQUFBLFVBQVUsQ0FBQ3dDLElBQVgsQ0FBZ0JpQixJQUFoQjs7QUFDQSxRQUFJLFFBQU9BLElBQVAsTUFBZ0IsUUFBcEIsRUFBOEI7QUFDNUIsVUFBSTFCLEtBQUssR0FBR2xCLE1BQU0sQ0FBQ21CLG1CQUFQLENBQTJCeUIsSUFBM0IsQ0FBWjs7QUFDQSxXQUFLLElBQUkxQyxDQUFDLEdBQUcsQ0FBYixFQUFnQkEsQ0FBQyxHQUFHZ0IsS0FBSyxDQUFDdEIsTUFBMUIsRUFBa0NNLENBQUMsRUFBbkMsRUFBdUM7QUFDckNKLFFBQUFBLFdBQVcsQ0FBQzhDLElBQUksQ0FBQzFCLEtBQUssQ0FBQ2hCLENBQUQsQ0FBTixDQUFMLEVBQWlCZixVQUFqQixDQUFYO0FBQ0Q7QUFDRjtBQUNGO0FBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBKYXZhU2NyaXB0IEludGVycHJldGVyOiBzZXJpYWxpemF0aW9uIGFuZCBkZXNlcmlhbGl6YXRpb25cbiAqXG4gKiBDb3B5cmlnaHQgMjAxNyBHb29nbGUgSW5jLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuLyoqXG4gKiBAZmlsZW92ZXJ2aWV3IFNhdmluZyBhbmQgcmVzdG9yaW5nIHRoZSBzdGF0ZSBvZiBhIEpTLUludGVwcmV0ZXIuXG4gKiBAYXV0aG9yIGZyYXNlckBnb29nbGUuY29tIChOZWlsIEZyYXNlcilcbiAqL1xuJ3VzZSBzdHJpY3QnO1xuXG5mdW5jdGlvbiBkZXNlcmlhbGl6ZShqc29uLCBpbnRlcnByZXRlcikge1xuICBmdW5jdGlvbiBkZWNvZGVWYWx1ZSh2YWx1ZSkge1xuICAgIGlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnKSB7XG4gICAgICB2YXIgZGF0YTtcbiAgICAgIGlmICgoZGF0YSA9IHZhbHVlWycjJ10pKSB7XG4gICAgICAgLy8gT2JqZWN0IHJlZmVyZW5jZTogeycjJzogNDJ9XG4gICAgICAgdmFsdWUgPSBvYmplY3RMaXN0W2RhdGFdO1xuICAgICAgICBpZiAoIXZhbHVlKSB7XG4gICAgICAgICAgdGhyb3cgUmVmZXJlbmNlRXJyb3IoJ09iamVjdCByZWZlcmVuY2Ugbm90IGZvdW5kOiAnICsgZGF0YSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgfVxuICAgICAgaWYgKChkYXRhID0gdmFsdWVbJ051bWJlciddKSkge1xuICAgICAgICAvLyBTcGVjaWFsIG51bWJlcjogeydOdW1iZXInOiAnSW5maW5pdHknfVxuICAgICAgICByZXR1cm4gTnVtYmVyKGRhdGEpO1xuICAgICAgfVxuICAgICAgaWYgKChkYXRhID0gdmFsdWVbJ1ZhbHVlJ10pKSB7XG4gICAgICAgIC8vIFNwZWNpYWwgdmFsdWU6IHsnVmFsdWUnOiAndW5kZWZpbmVkJ31cbiAgICAgICAgaWYgKHZhbHVlWydWYWx1ZSddID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHZhbHVlO1xuICB9XG4gIHZhciBzdGFjayA9IGludGVycHJldGVyLnN0YXRlU3RhY2s7XG4gIGlmICghQXJyYXkuaXNBcnJheShqc29uKSkge1xuICAgIHRocm93IFR5cGVFcnJvcignVG9wLWxldmVsIEpTT04gaXMgbm90IGEgbGlzdC4nKTtcbiAgfVxuICBpZiAoIXN0YWNrLmxlbmd0aCkge1xuICAgIC8vIFJlcXVpcmUgbmF0aXZlIGZ1bmN0aW9ucyB0byBiZSBwcmVzZW50LlxuICAgIHRocm93IEVycm9yKCdJbnRlcnByZXRlciBtdXN0IGJlIGluaXRpYWxpemVkIHByaW9yIHRvIGRlc2VyaWFsaXphdGlvbi4nKTtcbiAgfVxuICAvLyBGaW5kIGFsbCBuYXRpdmUgZnVuY3Rpb25zIGluIGV4aXN0aW5nIGludGVycHJldGVyLlxuICB2YXIgb2JqZWN0TGlzdCA9IFtdO1xuICBvYmplY3RIdW50XyhzdGFjaywgb2JqZWN0TGlzdCk7XG4gIHZhciBmdW5jdGlvbkhhc2ggPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuICBmb3IgKHZhciBpID0gMDsgaSA8IG9iamVjdExpc3QubGVuZ3RoOyBpKyspIHtcbiAgICBpZiAodHlwZW9mIG9iamVjdExpc3RbaV0gPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgZnVuY3Rpb25IYXNoW29iamVjdExpc3RbaV0uaWRdID0gb2JqZWN0TGlzdFtpXTtcbiAgICB9XG4gIH1cbiAgLy8gRmlyc3QgcGFzczogQ3JlYXRlIG9iamVjdCBzdHVicyBmb3IgZXZlcnkgb2JqZWN0LlxuICBvYmplY3RMaXN0ID0gW107XG4gIGZvciAodmFyIGkgPSAwOyBpIDwganNvbi5sZW5ndGg7IGkrKykge1xuICAgIHZhciBqc29uT2JqID0ganNvbltpXTtcbiAgICB2YXIgb2JqO1xuICAgIHN3aXRjaCAoanNvbk9ialsndHlwZSddKSB7XG4gICAgICBjYXNlICdNYXAnOlxuICAgICAgICBvYmogPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ09iamVjdCc6XG4gICAgICAgIG9iaiA9IHt9O1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ1Njb3BlUmVmZXJlbmNlJzpcbiAgICAgICAgb2JqID0gSW50ZXJwcmV0ZXIuU0NPUEVfUkVGRVJFTkNFO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ0Z1bmN0aW9uJzpcbiAgICAgICAgb2JqID0gZnVuY3Rpb25IYXNoW2pzb25PYmpbJ2lkJ11dO1xuICAgICAgICBpZiAoIW9iaikge1xuICAgICAgICAgIHRocm93IFJhbmdlRXJyb3IoJ0Z1bmN0aW9uIElEIG5vdCBmb3VuZDogJyArIGpzb25PYmpbJ2lkJ10pO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnQXJyYXknOlxuICAgICAgICAvLyBDdXJyZW50bHkgd2UgYXNzdW1lIHRoYXQgQXJyYXlzIGFyZSBub3Qgc3BhcnNlLlxuICAgICAgICBvYmogPSBbXTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdEYXRlJzpcbiAgICAgICAgb2JqID0gbmV3IERhdGUoanNvbk9ialsnZGF0YSddKTtcbiAgICAgICAgaWYgKGlzTmFOKG9iaikpIHtcbiAgICAgICAgICB0aHJvdyBUeXBlRXJyb3IoJ0ludmFsaWQgZGF0ZTogJyArIGpzb25PYmpbJ2RhdGEnXSk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdSZWdFeHAnOlxuICAgICAgICBvYmogPSBSZWdFeHAoanNvbk9ialsnc291cmNlJ10sIGpzb25PYmpbJ2ZsYWdzJ10pO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ1BzZXVkb09iamVjdCc6XG4gICAgICAgIG9iaiA9IG5ldyBJbnRlcnByZXRlci5PYmplY3QobnVsbCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnU3RhdGUnOlxuICAgICAgICBvYmogPSBuZXcgSW50ZXJwcmV0ZXIuU3RhdGUodW5kZWZpbmVkLCB1bmRlZmluZWQpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ05vZGUnOlxuICAgICAgICBvYmogPSBuZXcgaW50ZXJwcmV0ZXIubm9kZUNvbnN0cnVjdG9yKCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhyb3cgVHlwZUVycm9yKCdVbmtub3duIHR5cGU6ICcgKyBqc29uT2JqWyd0eXBlJ10pO1xuICAgIH1cbiAgICBvYmplY3RMaXN0W2ldID0gb2JqO1xuICB9XG4gIC8vIFNlY29uZCBwYXNzOiBQb3B1bGF0ZSBwcm9wZXJ0aWVzIGZvciBldmVyeSBvYmplY3QuXG4gIGZvciAodmFyIGkgPSAwOyBpIDwganNvbi5sZW5ndGg7IGkrKykge1xuICAgIHZhciBqc29uT2JqID0ganNvbltpXTtcbiAgICB2YXIgb2JqID0gb2JqZWN0TGlzdFtpXTtcbiAgICAvLyBSZXBvcHVsYXRlIG9iamVjdHMuXG4gICAgdmFyIHByb3BzID0ganNvbk9ialsncHJvcHMnXTtcbiAgICBpZiAocHJvcHMpIHtcbiAgICAgIHZhciBub25Db25maWd1cmFibGUgPSBqc29uT2JqWydub25Db25maWd1cmFibGUnXSB8fCBbXTtcbiAgICAgIHZhciBub25FbnVtZXJhYmxlID0ganNvbk9ialsnbm9uRW51bWVyYWJsZSddIHx8IFtdO1xuICAgICAgdmFyIG5vbldyaXRhYmxlID0ganNvbk9ialsnbm9uV3JpdGFibGUnXSB8fCBbXTtcbiAgICAgIHZhciBuYW1lcyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHByb3BzKTtcbiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgbmFtZXMubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgdmFyIG5hbWUgPSBuYW1lc1tqXTtcbiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwgbmFtZSxcbiAgICAgICAgICAgIHtjb25maWd1cmFibGU6IG5vbkNvbmZpZ3VyYWJsZS5pbmRleE9mKG5hbWUpID09PSAtMSxcbiAgICAgICAgICAgICBlbnVtZXJhYmxlOiBub25FbnVtZXJhYmxlLmluZGV4T2YobmFtZSkgPT09IC0xLFxuICAgICAgICAgICAgIHdyaXRhYmxlOiBub25Xcml0YWJsZS5pbmRleE9mKG5hbWUpID09PSAtMSxcbiAgICAgICAgICAgICB2YWx1ZTogZGVjb2RlVmFsdWUocHJvcHNbbmFtZV0pfSk7XG4gICAgICB9XG4gICAgfVxuICAgIC8vIFJlcG9wdWxhdGUgYXJyYXlzLlxuICAgIGlmIChBcnJheS5pc0FycmF5KG9iaikpIHtcbiAgICAgIHZhciBkYXRhID0ganNvbk9ialsnZGF0YSddO1xuICAgICAgaWYgKGRhdGEpIHtcbiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBkYXRhLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgb2JqLnB1c2goZGVjb2RlVmFsdWUoZGF0YVtqXSkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG4gIC8vIEZpcnN0IG9iamVjdCBpcyB0aGUgaW50ZXJwcmV0ZXIuXG4gIHZhciByb290ID0gb2JqZWN0TGlzdFswXTtcbiAgZm9yICh2YXIgcHJvcCBpbiByb290KSB7XG4gICAgaW50ZXJwcmV0ZXJbcHJvcF0gPSByb290W3Byb3BdO1xuICB9XG59XG5cbmZ1bmN0aW9uIHNlcmlhbGl6ZShpbnRlcnByZXRlcikge1xuICBmdW5jdGlvbiBlbmNvZGVWYWx1ZSh2YWx1ZSkge1xuICAgIGlmICh2YWx1ZSAmJiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyB8fCB0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicpKSB7XG4gICAgICB2YXIgcmVmID0gb2JqZWN0TGlzdC5pbmRleE9mKHZhbHVlKTtcbiAgICAgIGlmIChyZWYgPT09IC0xKSB7XG4gICAgICAgIHRocm93IFJhbmdlRXJyb3IoJ09iamVjdCBub3QgZm91bmQgaW4gdGFibGUuJyk7XG4gICAgICB9XG4gICAgICByZXR1cm4geycjJzogcmVmfTtcbiAgICB9XG4gICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiB7J1ZhbHVlJzogJ3VuZGVmaW5lZCd9O1xuICAgIH1cbiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJykge1xuICAgICAgaWYgKHZhbHVlID09PSBJbmZpbml0eSkge1xuICAgICAgICByZXR1cm4geydOdW1iZXInOiAnSW5maW5pdHknfTtcbiAgICAgIH0gZWxzZSBpZiAodmFsdWUgPT09IC1JbmZpbml0eSkge1xuICAgICAgICByZXR1cm4geydOdW1iZXInOiAnLUluZmluaXR5J307XG4gICAgICB9IGVsc2UgaWYgKGlzTmFOKHZhbHVlKSkge1xuICAgICAgICByZXR1cm4geydOdW1iZXInOiAnTmFOJ307XG4gICAgICB9IGVsc2UgaWYgKDEgLyB2YWx1ZSA9PT0gLUluZmluaXR5KSB7XG4gICAgICAgIHJldHVybiB7J051bWJlcic6ICctMCd9O1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdmFsdWU7XG4gIH1cbiAgLy8gU2hhbGxvdy1jb3B5IGFsbCBwcm9wZXJ0aWVzIG9mIGludGVyZXN0IG9udG8gYSByb290IG9iamVjdC5cbiAgdmFyIHByb3BlcnRpZXMgPSBbXG4gICAgJ09CSkVDVCcsICdPQkpFQ1RfUFJPVE8nLFxuICAgICdGVU5DVElPTicsICdGVU5DVElPTl9QUk9UTycsXG4gICAgJ0FSUkFZJywgJ0FSUkFZX1BST1RPJyxcbiAgICAnUkVHRVhQJywgJ1JFR0VYUF9QUk9UTycsXG4gICAgJ0JPT0xFQU4nLFxuICAgICdEQVRFJyxcbiAgICAnTlVNQkVSJyxcbiAgICAnU1RSSU5HJyxcbiAgICAnRVJST1InLFxuICAgICdFVkFMX0VSUk9SJyxcbiAgICAnUkFOR0VfRVJST1InLFxuICAgICdSRUZFUkVOQ0VfRVJST1InLFxuICAgICdTWU5UQVhfRVJST1InLFxuICAgICdUWVBFX0VSUk9SJyxcbiAgICAnVVJJX0VSUk9SJyxcbiAgICAnZ2xvYmFsJyxcbiAgICAnc3RhdGVTdGFjaydcbiAgXTtcbiAgdmFyIHJvb3QgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuICBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BlcnRpZXMubGVuZ3RoOyBpKyspIHtcbiAgICByb290W3Byb3BlcnRpZXNbaV1dID0gaW50ZXJwcmV0ZXJbcHJvcGVydGllc1tpXV07XG4gIH1cblxuICAvLyBGaW5kIGFsbCBvYmplY3RzLlxuICB2YXIgb2JqZWN0TGlzdCA9IFtdO1xuICBvYmplY3RIdW50Xyhyb290LCBvYmplY3RMaXN0KTtcbiAgLy8gU2VyaWFsaXplIGV2ZXJ5IG9iamVjdC5cbiAgdmFyIGpzb24gPSBbXTtcbiAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmplY3RMaXN0Lmxlbmd0aDsgaSsrKSB7XG4gICAgdmFyIGpzb25PYmogPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuICAgIGpzb24ucHVzaChqc29uT2JqKTtcbiAgICB2YXIgb2JqID0gb2JqZWN0TGlzdFtpXTtcbiAgICAvLyBVbmNvbW1lbnQgdGhpcyBsaW5lIGZvciBhIGRlYnVnZ2luZyBsYWJlbC5cbiAgICAvL2pzb25PYmpbJyMnXSA9IGk7XG4gICAgc3dpdGNoIChPYmplY3QuZ2V0UHJvdG90eXBlT2Yob2JqKSkge1xuICAgICAgY2FzZSBudWxsOlxuICAgICAgICBqc29uT2JqWyd0eXBlJ10gPSAnTWFwJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIE9iamVjdC5wcm90b3R5cGU6XG4gICAgICAgIGlmIChvYmogPT09IEludGVycHJldGVyLlNDT1BFX1JFRkVSRU5DRSkge1xuICAgICAgICAgIGpzb25PYmpbJ3R5cGUnXSA9ICdTY29wZVJlZmVyZW5jZSc7XG4gICAgICAgICAgY29udGludWU7ICAvLyBObyBuZWVkIHRvIGluZGV4IHByb3BlcnRpZXMuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAganNvbk9ialsndHlwZSddID0gJ09iamVjdCc7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIEZ1bmN0aW9uLnByb3RvdHlwZTpcbiAgICAgICAganNvbk9ialsndHlwZSddID0gJ0Z1bmN0aW9uJztcbiAgICAgICAganNvbk9ialsnaWQnXSA9IG9iai5pZDtcbiAgICAgICAgaWYgKG9iai5pZCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgdGhyb3cgRXJyb3IoJ05hdGl2ZSBmdW5jdGlvbiBoYXMgbm8gSUQ6ICcgKyBvYmopO1xuICAgICAgICB9XG4gICAgICAgIGNvbnRpbnVlOyAgLy8gTm8gbmVlZCB0byBpbmRleCBwcm9wZXJ0aWVzLlxuICAgICAgY2FzZSBBcnJheS5wcm90b3R5cGU6XG4gICAgICAgIC8vIEN1cnJlbnRseSB3ZSBhc3N1bWUgdGhhdCBBcnJheXMgYXJlIG5vdCBzcGFyc2UuXG4gICAgICAgIGpzb25PYmpbJ3R5cGUnXSA9ICdBcnJheSc7XG4gICAgICAgIGlmIChvYmoubGVuZ3RoKSB7XG4gICAgICAgICAganNvbk9ialsnZGF0YSddID0gb2JqLm1hcChlbmNvZGVWYWx1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgY29udGludWU7ICAvLyBObyBuZWVkIHRvIGluZGV4IHByb3BlcnRpZXMuXG4gICAgICBjYXNlIERhdGUucHJvdG90eXBlOlxuICAgICAgICBqc29uT2JqWyd0eXBlJ10gPSAnRGF0ZSc7XG4gICAgICAgIGpzb25PYmpbJ2RhdGEnXSA9IG9iai50b0pTT04oKTtcbiAgICAgICAgY29udGludWU7ICAvLyBObyBuZWVkIHRvIGluZGV4IHByb3BlcnRpZXMuXG4gICAgICBjYXNlIFJlZ0V4cC5wcm90b3R5cGU6XG4gICAgICAgIGpzb25PYmpbJ3R5cGUnXSA9ICdSZWdFeHAnO1xuICAgICAgICBqc29uT2JqWydzb3VyY2UnXSA9IG9iai5zb3VyY2U7XG4gICAgICAgIGpzb25PYmpbJ2ZsYWdzJ10gPSBvYmouZmxhZ3M7XG4gICAgICAgIGNvbnRpbnVlOyAgLy8gTm8gbmVlZCB0byBpbmRleCBwcm9wZXJ0aWVzLlxuICAgICAgY2FzZSBJbnRlcnByZXRlci5PYmplY3QucHJvdG90eXBlOlxuICAgICAgICBqc29uT2JqWyd0eXBlJ10gPSAnUHNldWRvT2JqZWN0JztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIEludGVycHJldGVyLlN0YXRlLnByb3RvdHlwZTpcbiAgICAgICAganNvbk9ialsndHlwZSddID0gJ1N0YXRlJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIGludGVycHJldGVyLm5vZGVDb25zdHJ1Y3Rvci5wcm90b3R5cGU6XG4gICAgICAgIGpzb25PYmpbJ3R5cGUnXSA9ICdOb2RlJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aHJvdyBUeXBlRXJyb3IoJ1Vua25vd24gdHlwZTogJyArIG9iaik7XG4gICAgfVxuICAgIHZhciBwcm9wcyA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG4gICAgdmFyIG5vbkNvbmZpZ3VyYWJsZSA9IFtdO1xuICAgIHZhciBub25FbnVtZXJhYmxlID0gW107XG4gICAgdmFyIG5vbldyaXRhYmxlID0gW107XG4gICAgdmFyIG5hbWVzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMob2JqKTtcbiAgICBmb3IgKHZhciBqID0gMDsgaiA8IG5hbWVzLmxlbmd0aDsgaisrKSB7XG4gICAgICB2YXIgbmFtZSA9IG5hbWVzW2pdO1xuICAgICAgcHJvcHNbbmFtZV0gPSBlbmNvZGVWYWx1ZShvYmpbbmFtZV0pO1xuICAgICAgdmFyIGRlc2NyaXB0b3IgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iaiwgbmFtZSk7XG4gICAgICBpZiAoIWRlc2NyaXB0b3IuY29uZmlndXJhYmxlKSB7XG4gICAgICAgIG5vbkNvbmZpZ3VyYWJsZS5wdXNoKG5hbWUpO1xuICAgICAgfVxuICAgICAgaWYgKCFkZXNjcmlwdG9yLmVudW1lcmFibGUpIHtcbiAgICAgICAgbm9uRW51bWVyYWJsZS5wdXNoKG5hbWUpO1xuICAgICAgfVxuICAgICAgaWYgKCFkZXNjcmlwdG9yLndyaXRhYmxlKSB7XG4gICAgICAgIG5vbldyaXRhYmxlLnB1c2gobmFtZSk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChuYW1lcy5sZW5ndGgpIHtcbiAgICAgIGpzb25PYmpbJ3Byb3BzJ10gPSBwcm9wcztcbiAgICB9XG4gICAgaWYgKG5vbkNvbmZpZ3VyYWJsZS5sZW5ndGgpIHtcbiAgICAgIGpzb25PYmpbJ25vbkNvbmZpZ3VyYWJsZSddID0gbm9uQ29uZmlndXJhYmxlO1xuICAgIH1cbiAgICBpZiAobm9uRW51bWVyYWJsZS5sZW5ndGgpIHtcbiAgICAgIGpzb25PYmpbJ25vbkVudW1lcmFibGUnXSA9IG5vbkVudW1lcmFibGU7XG4gICAgfVxuICAgIGlmIChub25Xcml0YWJsZS5sZW5ndGgpIHtcbiAgICAgIGpzb25PYmpbJ25vbldyaXRhYmxlJ10gPSBub25Xcml0YWJsZTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGpzb247XG59XG5cbi8vIFJlY3Vyc2l2ZWx5IHNlYXJjaCB0aGUgc3RhY2sgdG8gZmluZCBhbGwgbm9uLXByaW1pdGl2ZXMuXG5mdW5jdGlvbiBvYmplY3RIdW50Xyhub2RlLCBvYmplY3RMaXN0KSB7XG4gIGlmIChub2RlICYmICh0eXBlb2Ygbm9kZSA9PT0gJ29iamVjdCcgfHwgdHlwZW9mIG5vZGUgPT09ICdmdW5jdGlvbicpKSB7XG4gICAgaWYgKG9iamVjdExpc3QuaW5kZXhPZihub2RlKSAhPSAtMSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBvYmplY3RMaXN0LnB1c2gobm9kZSk7XG4gICAgaWYgKHR5cGVvZiBub2RlID09PSAnb2JqZWN0JykgeyAgLy8gUmVjdXJzZS5cbiAgICAgIHZhciBuYW1lcyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKG5vZGUpO1xuICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuYW1lcy5sZW5ndGg7IGkrKykge1xuICAgICAgICBvYmplY3RIdW50Xyhub2RlW25hbWVzW2ldXSwgb2JqZWN0TGlzdCk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXSwiZmlsZSI6ImxpYi9KUy1JbnRlcnByZXRlci9kZW1vcy9zZXJpYWxpemUuanMifQ==
