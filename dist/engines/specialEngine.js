"use strict";

require("core-js/modules/es.array.for-each");

require("core-js/modules/es.array.index-of");

require("core-js/modules/es.date.to-string");

require("core-js/modules/es.object.define-property");

require("core-js/modules/es.object.get-own-property-descriptor");

require("core-js/modules/web.dom-collections.for-each");

require("core-js/modules/web.timers");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _linkedList = _interopRequireDefault(require("../lib/linkedList"));

var _renderersFactory = _interopRequireDefault(require("../renderers/renderersFactory"));

var _helper = _interopRequireDefault(require("../lib/helper"));

var _resources = _interopRequireDefault(require("../lib/resources"));

var build = _interopRequireWildcard(require("../build.json"));

var _acorn_interpreter = require("../lib/JS-Interpreter/acorn_interpreter");

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj["default"] = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var SpecialEngine = function SpecialEngine(element, options) {
  var renderMode = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 'canvas';

  _classCallCheck(this, SpecialEngine);

  /**
   * 开始时间
   * @private @type {number}
   */
  var _startTime;
  /**
   * 暂停时间
   * @private @type {number}
   */


  var _pauseTime = 0;
  /**
   * 弹幕缓冲区
   * @private @type {LinkedList}
   */

  var _bulletScreenBuffer = new _linkedList["default"]();
  /**
   * 实时弹幕列表
   * @private @type {LinkedList}
   */


  var _realTimeBulletScreens = new _linkedList["default"]();
  /**
   * 延迟弹幕总数
   * @private @type {number}
   */


  var _delayBulletScreenCount = 0;
  /**
   * 延迟（单位：毫秒）
   * @private @type {number}
   */

  var _delay = 0;
  /**
   * 播放标志
   * @private @type {boolean}
   */

  var _playing;
  /**
   * 刷新频率
   * @private @type {number}
   */


  var _refreshRate = 0.06;
  /**
   * 上一次刷新时间
   * @private @type {number}
   */

  var _lastRefreshTime;
  /**
   * 全局选项
   * @private @type {openBSE~specialOptions}
   */


  var _options;
  /**
   * 默认全局变量
   * @private @readonly
   */


  var _defaultOptions = {
    /** 播放速度(倍数) */
    playSpeed: 1,

    /** 时间基准 */
    clock: function clock(time) {
      return new Date().getTime() - _startTime;
    },

    /** 缩放比例 */
    scaling: 1,

    /** 超时丢弃 */
    timeOutDiscard: true,

    /** 弹幕不透明度 */
    opacity: 1
    /**
     * 全局选项类型
     * @private @readonly
     */

  };
  var _optionsType = {
    playSpeed: 'number',
    clock: 'function',
    scaling: 'number',
    timeOutDiscard: 'boolean',
    opacity: 'number'
    /**
     * 默认弹幕数据
     * @private @readonly
     */

  };
  var _defaultBulletScreen = {
    /** 弹幕文本 */
    text: null,

    /** 是否允许丢弃 */
    canDiscard: true,

    /** 弹幕进入时间 */
    startTime: null,

    /** 弹幕退出时间 */
    endTime: null,

    /** 弹幕渲染代码 */
    renderCode: null
    /**
     * 弹幕数据类型
     * @private @readonly
     */

  };
  var _bulletScreenType = {
    text: 'string',
    canDiscard: 'boolean',
    startTime: 'number',
    endTime: 'number',
    renderCode: 'string'
    /**
     * requestAnimationFrame 定义（一些老式浏览器不支持 requestAnimationFrame ）
     * @param {function} fun - 回调方法 
     * @function
     */

  };
  var requestAnimationFrame;
  if (typeof window.requestAnimationFrame === 'function') requestAnimationFrame = window.requestAnimationFrame;else {
    console.warn(_resources["default"].REQUESTANIMATIONFRAME_NOT_SUPPORT_WARN);

    requestAnimationFrame = function requestAnimationFrame(fun) {
      return window.setTimeout(fun, 17);
    };
  }
  _options = _helper["default"].setValues(options, _defaultOptions, _optionsType);
  var _elementSize = {
    width: element.clientWidth / _options.scaling,
    height: element.clientHeight / _options.scaling
  };

  var _oldDevicePixelRatio = _helper["default"].getDevicePixelRatio();

  var _oldScaling = _options.scaling;
  var _oldClientWidth = element.clientWidth;
  var _oldClientHeight = element.clientHeight;
  var _oldOpacity = _options.opacity;
  var renderersFactory = new _renderersFactory["default"](element, _options, _elementSize, bulletScreenEventTrigger);

  var _renderer = renderersFactory.getGeneralRenderer(renderMode);

  setInterval(setSize, 100);
  /**
   * 设置或获取全局选项
   * @private
   **/

  Object.defineProperty(this, 'options', {
    get: function get() {
      return _helper["default"].clone(_options);
    },
    set: function set(options) {
      _options = _helper["default"].setValues(options, _options, _optionsType, false);

      if (_oldOpacity != _options.opacity) {
        _oldOpacity = _options.opacity;

        _renderer.setOpacity();
      }
    }
  });
  /**
   * 添加弹幕到弹幕列表。
   * @description 添加弹幕到弹幕列表。由于弹幕在屏幕上出现过后，弹幕引擎将从列表中彻底删除此弹幕。所以，在改变播放进度时，可能需要先[清空弹幕列表]{@link openBSE.BulletScreenEngine#cleanBulletScreenList}，然后重新加载此播放进度以后的弹幕。
   * @param {openBSE~SpecialBulletScreen} bulletScreen - 单条弹幕数据：一个 {@link openBSE~SpecialBulletScreen} 结构。
   * @throws {TypeError} 传入的参数错误时引发错误。请参阅 MDN [TypeError]{@link https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/TypeError} 。
   */

  this.add = function (bulletScreen) {
    _defaultBulletScreen.startTime = _options.clock();
    bulletScreen = _helper["default"].setValues(bulletScreen, _defaultBulletScreen, _bulletScreenType);
    bulletScreen.interpreter = new _acorn_interpreter.Interpreter(bulletScreen.renderCode, function (interpreter, scope) {
      interpreter.setProperty;
    });
    var newNode = new _linkedList["default"].node(bulletScreen);

    _bulletScreenBuffer.forEach(function (node) {
      var lastBulletScreen = node.element;

      if (bulletScreen.startTime > lastBulletScreen.startTime) {
        return {
          add: {
            addToUp: true,
            node: newNode
          },
          stop: true
        };
      }
    }, true);

    if (newNode.linkedList === null) _bulletScreenBuffer.push(newNode, false);
  };
  /**
   * 开始播放弹幕。
   */


  this.play = function () {
    if (!_playing) {
      if (!_startTime) _startTime = new Date().getTime();
      if (_pauseTime) _startTime += _options.clock() - _pauseTime;
      _lastRefreshTime = null;
      _playing = true;
      requestAnimationFrame(refresh);
    }
  };
  /**
   * 暂停播放弹幕。
   * @description 暂停播放弹幕。暂停播放弹幕是指弹幕播放暂停，所有未出现的弹幕将停止出现，已出现的弹幕停止运动，停止消失。
   */


  this.pause = function () {
    if (_playing) {
      _pauseTime = _options.clock();
      _playing = false;
    }
  };
  /**
   * 清空弹幕缓冲区。
   * @description 清空弹幕列表，但屏幕上已经出现的弹幕不会被清除。
   */


  this.cleanBuffer = function () {
    _bulletScreenBuffer.clean();
  };
  /**
   * 清空屏幕内容。
   * @description 清空屏幕内容。清空屏幕上已经出现的弹幕，不包括弹幕列表中的弹幕。
   */


  this.cleanScreen = function () {
    _realTimeBulletScreens.clean();

    _renderer.cleanScreen();
  };
  /**
   * 停止播放弹幕。
   * @description 停止播放弹幕。停止播放弹幕是指停止播放弹幕，默认[时间基准（options.clock）]{@link openBSE~BulletScreenStyle}归零，并[清空弹幕列表]{@link openBSE.BulletScreenEngine#cleanBulletScreenList}、[清空屏幕内容]{@link openBSE.BulletScreenEngine#cleanScreen}。
   */


  this.stop = function () {
    if (_playing) {
      this.pause();
    }

    this.cleanBuffer();
    this.cleanScreen();
    _pauseTime = 0;
    _startTime = null;
  };
  /**
   * 获取或设置弹幕可见性。
   * @private
   */


  Object.defineProperty(this, 'visibility', {
    get: function get() {
      return renderer.getVisibility();
    },
    set: function set(visibility) {
      if (visibility) _renderer.show();else _renderer.hide();
    }
  });
  /**
   * 获取渲染模式。
   * @private
   */

  Object.defineProperty(this, 'renderMode', {
    get: function get() {
      return renderMode;
    }
  });
  /**
   * 获取播放状态。
   * @private
   */

  Object.defineProperty(this, 'playState', {
    get: function get() {
      return _playing;
    }
  });
  /**
  * 获取调试信息。
  * @private
  */

  Object.defineProperty(this, 'debugInfo', {
    get: function get() {
      return {
        time: _playing ? _options.clock() : _pauseTime,
        realTimeBulletScreenCount: _realTimeBulletScreens.length,
        bufferBulletScreenCount: _bulletScreenBuffer.length,
        delay: _delay,
        delayBulletScreenCount: _delayBulletScreenCount,
        fps: _playing ? Math.floor(_refreshRate * 1000) : 0
      };
    }
  });
  /**
   * 设置尺寸
   * @private
   */

  function setSize() {
    var devicePixelRatio = _helper["default"].getDevicePixelRatio();

    if (_oldDevicePixelRatio != devicePixelRatio || _oldClientWidth != element.clientWidth || _oldClientHeight != element.clientHeight || _oldScaling != _options.scaling) {
      _oldScaling = _options.scaling;
      _elementSize.width = element.clientWidth / _options.scaling;
      _elementSize.height = element.clientHeight / _options.scaling;
      _oldClientWidth = element.clientWidth;
      _oldClientHeight = element.clientHeight;
      _oldDevicePixelRatio = devicePixelRatio;

      _renderer.setSize();

      if (!_playing) _renderer.draw();
    }
  }

  if (!!window.ActiveXObject || "ActiveXObject" in window || navigator.userAgent.indexOf("Trident") > -1 || navigator.userAgent.indexOf("MSIE") > -1 || navigator.userAgent.indexOf("Edge") > -1) console.info(_resources["default"].LOADED_INFO_IE.fillData(build));else console.info(_resources["default"].LOADED_INFO.fillData(build), 'font-weight:bold; color:#0099FF;', '', 'font-style:italic;', '');
};

exports["default"] = SpecialEngine;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVuZ2luZXMvc3BlY2lhbEVuZ2luZS5qcyJdLCJuYW1lcyI6WyJTcGVjaWFsRW5naW5lIiwiZWxlbWVudCIsIm9wdGlvbnMiLCJyZW5kZXJNb2RlIiwiX3N0YXJ0VGltZSIsIl9wYXVzZVRpbWUiLCJfYnVsbGV0U2NyZWVuQnVmZmVyIiwiTGlua2VkTGlzdCIsIl9yZWFsVGltZUJ1bGxldFNjcmVlbnMiLCJfZGVsYXlCdWxsZXRTY3JlZW5Db3VudCIsIl9kZWxheSIsIl9wbGF5aW5nIiwiX3JlZnJlc2hSYXRlIiwiX2xhc3RSZWZyZXNoVGltZSIsIl9vcHRpb25zIiwiX2RlZmF1bHRPcHRpb25zIiwicGxheVNwZWVkIiwiY2xvY2siLCJ0aW1lIiwiRGF0ZSIsImdldFRpbWUiLCJzY2FsaW5nIiwidGltZU91dERpc2NhcmQiLCJvcGFjaXR5IiwiX29wdGlvbnNUeXBlIiwiX2RlZmF1bHRCdWxsZXRTY3JlZW4iLCJ0ZXh0IiwiY2FuRGlzY2FyZCIsInN0YXJ0VGltZSIsImVuZFRpbWUiLCJyZW5kZXJDb2RlIiwiX2J1bGxldFNjcmVlblR5cGUiLCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJ3aW5kb3ciLCJjb25zb2xlIiwid2FybiIsIlJlc291cmNlcyIsIlJFUVVFU1RBTklNQVRJT05GUkFNRV9OT1RfU1VQUE9SVF9XQVJOIiwiZnVuIiwic2V0VGltZW91dCIsIkhlbHBlciIsInNldFZhbHVlcyIsIl9lbGVtZW50U2l6ZSIsIndpZHRoIiwiY2xpZW50V2lkdGgiLCJoZWlnaHQiLCJjbGllbnRIZWlnaHQiLCJfb2xkRGV2aWNlUGl4ZWxSYXRpbyIsImdldERldmljZVBpeGVsUmF0aW8iLCJfb2xkU2NhbGluZyIsIl9vbGRDbGllbnRXaWR0aCIsIl9vbGRDbGllbnRIZWlnaHQiLCJfb2xkT3BhY2l0eSIsInJlbmRlcmVyc0ZhY3RvcnkiLCJSZW5kZXJlcnNGYWN0b3J5IiwiYnVsbGV0U2NyZWVuRXZlbnRUcmlnZ2VyIiwiX3JlbmRlcmVyIiwiZ2V0R2VuZXJhbFJlbmRlcmVyIiwic2V0SW50ZXJ2YWwiLCJzZXRTaXplIiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJnZXQiLCJjbG9uZSIsInNldCIsInNldE9wYWNpdHkiLCJhZGQiLCJidWxsZXRTY3JlZW4iLCJpbnRlcnByZXRlciIsIkludGVycHJldGVyIiwic2NvcGUiLCJzZXRQcm9wZXJ0eSIsIm5ld05vZGUiLCJub2RlIiwiZm9yRWFjaCIsImxhc3RCdWxsZXRTY3JlZW4iLCJhZGRUb1VwIiwic3RvcCIsImxpbmtlZExpc3QiLCJwdXNoIiwicGxheSIsInJlZnJlc2giLCJwYXVzZSIsImNsZWFuQnVmZmVyIiwiY2xlYW4iLCJjbGVhblNjcmVlbiIsInJlbmRlcmVyIiwiZ2V0VmlzaWJpbGl0eSIsInZpc2liaWxpdHkiLCJzaG93IiwiaGlkZSIsInJlYWxUaW1lQnVsbGV0U2NyZWVuQ291bnQiLCJsZW5ndGgiLCJidWZmZXJCdWxsZXRTY3JlZW5Db3VudCIsImRlbGF5IiwiZGVsYXlCdWxsZXRTY3JlZW5Db3VudCIsImZwcyIsIk1hdGgiLCJmbG9vciIsImRldmljZVBpeGVsUmF0aW8iLCJkcmF3IiwiQWN0aXZlWE9iamVjdCIsIm5hdmlnYXRvciIsInVzZXJBZ2VudCIsImluZGV4T2YiLCJpbmZvIiwiTE9BREVEX0lORk9fSUUiLCJmaWxsRGF0YSIsImJ1aWxkIiwiTE9BREVEX0lORk8iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7OztJQUVxQkEsYSxHQUNqQix1QkFBWUMsT0FBWixFQUFxQkMsT0FBckIsRUFBcUQ7QUFBQSxNQUF2QkMsVUFBdUIsdUVBQVYsUUFBVTs7QUFBQTs7QUFFakQ7Ozs7QUFJQSxNQUFJQyxVQUFKO0FBQ0E7Ozs7OztBQUlBLE1BQUlDLFVBQVUsR0FBRyxDQUFqQjtBQUNBOzs7OztBQUlBLE1BQUlDLG1CQUFtQixHQUFHLElBQUlDLHNCQUFKLEVBQTFCO0FBQ0E7Ozs7OztBQUlBLE1B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RDtBQUNBcUIsTUFBQUEsWUFBWSxDQUFDRyxNQUFiLEdBQXNCNUMsT0FBTyxDQUFDNkMsWUFBUixHQUF1QmhDLFFBQVEsQ0FBQ08sT0FBdEQ7QUFDQTZCLE1BQUFBLGVBQWUsR0FBR2pELE9BQU8sQ0FBQzJDLFdBQTFCO0FBQ0FPLE1BQUFBLGdCQUFnQixHQUFHbEQsT0FBTyxDQUFDNkMsWUFBM0I7QUFDQUMsTUFBQUEsb0JBQW9CLEdBQUdvRCxnQkFBdkI7O0FBQ0EzQyxNQUFBQSxTQUFTLENBQUNHLE9BQVY7O0FBQ0EsVUFBSSxDQUFDaEQsUUFBTCxFQUFlNkMsU0FBUyxDQUFDNEMsSUFBVjtBQUNsQjtBQUNKOztBQUdELE1BQUksQ0FBQyxDQUFDbkUsTUFBTSxDQUFDb0UsYUFBVCxJQUEwQixtQkFBbUJwRSxNQUE3QyxJQUF1RHFFLFNBQVMsQ0FBQ0MsU0FBVixDQUFvQkMsT0FBcEIsQ0FBNEIsU0FBNUIsSUFBeUMsQ0FBQyxDQUFqRyxJQUNBRixTQUFTLENBQUNDLFNBQVYsQ0FBb0JDLE9BQXBCLENBQTRCLE1BQTVCLElBQXNDLENBQUMsQ0FEdkMsSUFDNENGLFNBQVMsQ0FBQ0MsU0FBVixDQUFvQkMsT0FBcEIsQ0FBNEIsTUFBNUIsSUFBc0MsQ0FBQyxDQUR2RixFQUMwRnRFLE9BQU8sQ0FBQ3VFLElBQVIsQ0FDbEZyRSxzQkFBVXNFLGNBQVYsQ0FBeUJDLFFBQXpCLENBQWtDQyxLQUFsQyxDQURrRixFQUQxRixLQUtLMUUsT0FBTyxDQUFDdUUsSUFBUixDQUNEckUsc0JBQVV5RSxXQUFWLENBQXNCRixRQUF0QixDQUErQkMsS0FBL0IsQ0FEQyxFQUVELGtDQUZDLEVBRW1DLEVBRm5DLEVBRXVDLG9CQUZ2QyxFQUU2RCxFQUY3RDtBQUlSLEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgTGlua2VkTGlzdCBmcm9tICcuLi9saWIvbGlua2VkTGlzdCdcbmltcG9ydCBSZW5kZXJlcnNGYWN0b3J5IGZyb20gJy4uL3JlbmRlcmVycy9yZW5kZXJlcnNGYWN0b3J5J1xuaW1wb3J0IEhlbHBlciBmcm9tICcuLi9saWIvaGVscGVyJ1xuaW1wb3J0IFJlc291cmNlcyBmcm9tICcuLi9saWIvcmVzb3VyY2VzJ1xuaW1wb3J0ICogYXMgYnVpbGQgZnJvbSAnLi4vYnVpbGQuanNvbidcbmltcG9ydCB7IEludGVycHJldGVyIH0gZnJvbSAnLi4vbGliL0pTLUludGVycHJldGVyL2Fjb3JuX2ludGVycHJldGVyJ1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTcGVjaWFsRW5naW5lIHtcbiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBvcHRpb25zLCByZW5kZXJNb2RlID0gJ2NhbnZhcycpIHtcbiAgICAgICAgLy/lj5jph4/liJ3lp4vljJZcbiAgICAgICAgLyoqXG4gICAgICAgICAqIOW8gOWni+aXtumXtFxuICAgICAgICAgKiBAcHJpdmF0ZSBAdHlwZSB7bnVtYmVyfVxuICAgICAgICAgKi9cbiAgICAgICAgbGV0IF9zdGFydFRpbWU7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiDmmoLlgZzml7bpl7RcbiAgICAgICAgICogQHByaXZhdGUgQHR5cGUge251bWJlcn1cbiAgICAgICAgICovXG4gICAgICAgIGxldCBfcGF1c2VUaW1lID0gMDtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIOW8ueW5lee8k+WGsuWMulxuICAgICAgICAgKiBAcHJpdmF0ZSBAdHlwZSB7TGlua2VkTGlzdH1cbiAgICAgICAgICovXG4gICAgICAgIGxldCBfYnVsbGV0U2NyZWVuQnVmZmVyID0gbmV3IExpbmtlZExpc3QoKTtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIOWunuaXtuW8ueW5leWIl+ihqFxuICAgICAgICAgKiBAcHJpdmF0ZSBAdHlwZSB7TGlua2VkTGlzdH1cbiAgICAgICAgICovXG4gICAgICAgIGxldCBfcmVhbFRpbWVCdWxsZXRTY3JlZW5zID0gbmV3IExpbmtlZExpc3QoKTtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIOW7tui/n+W8ueW5leaAu+aVsFxuICAgICAgICAgKiBAcHJpdmF0ZSBAdHlwZSB7bnVtYmVyfVxuICAgICAgICAgKi9cbiAgICAgICAgbGV0IF9kZWxheUJ1bGxldFNjcmVlbkNvdW50ID0gMDtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIOW7tui/n++8iOWNleS9je+8muavq+enku+8iVxuICAgICAgICAgKiBAcHJpdmF0ZSBAdHlwZSB7bnVtYmVyfVxuICAgICAgICAgKi9cbiAgICAgICAgbGV0IF9kZWxheSA9IDA7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiDmkq3mlL7moIflv5dcbiAgICAgICAgICogQHByaXZhdGUgQHR5cGUge2Jvb2xlYW59XG4gICAgICAgICAqL1xuICAgICAgICBsZXQgX3BsYXlpbmc7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiDliLfmlrDpopHnjodcbiAgICAgICAgICogQHByaXZhdGUgQHR5cGUge251bWJlcn1cbiAgICAgICAgICovXG4gICAgICAgIGxldCBfcmVmcmVzaFJhdGUgPSAwLjA2OyAvL+WIneWni+WIt+aWsOmikeeOh1xuICAgICAgICAvKipcbiAgICAgICAgICog5LiK5LiA5qyh5Yi35paw5pe26Ze0XG4gICAgICAgICAqIEBwcml2YXRlIEB0eXBlIHtudW1iZXJ9XG4gICAgICAgICAqL1xuICAgICAgICBsZXQgX2xhc3RSZWZyZXNoVGltZTtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIOWFqOWxgOmAiemhuVxuICAgICAgICAgKiBAcHJpdmF0ZSBAdHlwZSB7b3BlbkJTRX5zcGVjaWFsT3B0aW9uc31cbiAgICAgICAgICovXG4gICAgICAgIGxldCBfb3B0aW9ucztcbiAgICAgICAgLyoqXG4gICAgICAgICAqIOm7mOiupOWFqOWxgOWPmOmHj1xuICAgICAgICAgKiBAcHJpdmF0ZSBAcmVhZG9ubHlcbiAgICAgICAgICovXG4gICAgICAgIGNvbnN0IF9kZWZhdWx0T3B0aW9ucyA9IHtcbiAgICAgICAgICAgIC8qKiDmkq3mlL7pgJ/luqYo5YCN5pWwKSAqL1xuICAgICAgICAgICAgcGxheVNwZWVkOiAxLFxuICAgICAgICAgICAgLyoqIOaXtumXtOWfuuWHhiAqL1xuICAgICAgICAgICAgY2xvY2s6IHRpbWUgPT4gbmV3IERhdGUoKS5nZXRUaW1lKCkgLSBfc3RhcnRUaW1lLFxuICAgICAgICAgICAgLyoqIOe8qeaUvuavlOS+iyAqL1xuICAgICAgICAgICAgc2NhbGluZzogMSxcbiAgICAgICAgICAgIC8qKiDotoXml7bkuKLlvIMgKi9cbiAgICAgICAgICAgIHRpbWVPdXREaXNjYXJkOiB0cnVlLFxuICAgICAgICAgICAgLyoqIOW8ueW5leS4jemAj+aYjuW6piAqL1xuICAgICAgICAgICAgb3BhY2l0eTogMVxuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIOWFqOWxgOmAiemhueexu+Wei1xuICAgICAgICAgKiBAcHJpdmF0ZSBAcmVhZG9ubHlcbiAgICAgICAgICovXG4gICAgICAgIGNvbnN0IF9vcHRpb25zVHlwZSA9IHtcbiAgICAgICAgICAgIHBsYXlTcGVlZDogJ251bWJlcicsXG4gICAgICAgICAgICBjbG9jazogJ2Z1bmN0aW9uJyxcbiAgICAgICAgICAgIHNjYWxpbmc6ICdudW1iZXInLFxuICAgICAgICAgICAgdGltZU91dERpc2NhcmQ6ICdib29sZWFuJyxcbiAgICAgICAgICAgIG9wYWNpdHk6ICdudW1iZXInLFxuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIOm7mOiupOW8ueW5leaVsOaNrlxuICAgICAgICAgKiBAcHJpdmF0ZSBAcmVhZG9ubHlcbiAgICAgICAgICovXG4gICAgICAgIGNvbnN0IF9kZWZhdWx0QnVsbGV0U2NyZWVuID0ge1xuICAgICAgICAgICAgLyoqIOW8ueW5leaWh+acrCAqL1xuICAgICAgICAgICAgdGV4dDogbnVsbCxcbiAgICAgICAgICAgIC8qKiDmmK/lkKblhYHorrjkuKLlvIMgKi9cbiAgICAgICAgICAgIGNhbkRpc2NhcmQ6IHRydWUsXG4gICAgICAgICAgICAvKiog5by55bmV6L+b5YWl5pe26Ze0ICovXG4gICAgICAgICAgICBzdGFydFRpbWU6IG51bGwsXG4gICAgICAgICAgICAvKiog5by55bmV6YCA5Ye65pe26Ze0ICovXG4gICAgICAgICAgICBlbmRUaW1lOiBudWxsLFxuICAgICAgICAgICAgLyoqIOW8ueW5lea4suafk+S7o+eggSAqL1xuICAgICAgICAgICAgcmVuZGVyQ29kZTogbnVsbFxuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIOW8ueW5leaVsOaNruexu+Wei1xuICAgICAgICAgKiBAcHJpdmF0ZSBAcmVhZG9ubHlcbiAgICAgICAgICovXG4gICAgICAgIGNvbnN0IF9idWxsZXRTY3JlZW5UeXBlID0ge1xuICAgICAgICAgICAgdGV4dDogJ3N0cmluZycsXG4gICAgICAgICAgICBjYW5EaXNjYXJkOiAnYm9vbGVhbicsXG4gICAgICAgICAgICBzdGFydFRpbWU6ICdudW1iZXInLFxuICAgICAgICAgICAgZW5kVGltZTogJ251bWJlcicsXG4gICAgICAgICAgICByZW5kZXJDb2RlOiAnc3RyaW5nJ1xuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIHJlcXVlc3RBbmltYXRpb25GcmFtZSDlrprkuYnvvIjkuIDkupvogIHlvI/mtY/op4jlmajkuI3mlK/mjIEgcmVxdWVzdEFuaW1hdGlvbkZyYW1lIO+8iVxuICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBmdW4gLSDlm57osIPmlrnms5UgXG4gICAgICAgICAqIEBmdW5jdGlvblxuICAgICAgICAgKi9cbiAgICAgICAgbGV0IHJlcXVlc3RBbmltYXRpb25GcmFtZTtcbiAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID09PSAnZnVuY3Rpb24nKSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPSB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lO1xuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihSZXNvdXJjZXMuUkVRVUVTVEFOSU1BVElPTkZSQU1FX05PVF9TVVBQT1JUX1dBUk4pO1xuICAgICAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gKGZ1bikgPT4gd2luZG93LnNldFRpbWVvdXQoZnVuLCAxNyk7IC8vNjBmcHNcbiAgICAgICAgfVxuXG4gICAgICAgIF9vcHRpb25zID0gSGVscGVyLnNldFZhbHVlcyhvcHRpb25zLCBfZGVmYXVsdE9wdGlvbnMsIF9vcHRpb25zVHlwZSk7IC8v6K6+572u6buY6K6k5YC8XG4gICAgICAgIC8v5Yid5aeL5YyWXG4gICAgICAgIGxldCBfZWxlbWVudFNpemUgPSB7XG4gICAgICAgICAgICB3aWR0aDogZWxlbWVudC5jbGllbnRXaWR0aCAvIF9vcHRpb25zLnNjYWxpbmcsXG4gICAgICAgICAgICBoZWlnaHQ6IGVsZW1lbnQuY2xpZW50SGVpZ2h0IC8gX29wdGlvbnMuc2NhbGluZ1xuICAgICAgICB9XG4gICAgICAgIGxldCBfb2xkRGV2aWNlUGl4ZWxSYXRpbyA9IEhlbHBlci5nZXREZXZpY2VQaXhlbFJhdGlvKCk7XG4gICAgICAgIGxldCBfb2xkU2NhbGluZyA9IF9vcHRpb25zLnNjYWxpbmc7XG4gICAgICAgIGxldCBfb2xkQ2xpZW50V2lkdGggPSBlbGVtZW50LmNsaWVudFdpZHRoO1xuICAgICAgICBsZXQgX29sZENsaWVudEhlaWdodCA9IGVsZW1lbnQuY2xpZW50SGVpZ2h0O1xuICAgICAgICBsZXQgX29sZE9wYWNpdHkgPSBfb3B0aW9ucy5vcGFjaXR5O1xuICAgICAgICAvL+a4suafk+WZqOW3peWOglxuICAgICAgICBsZXQgcmVuZGVyZXJzRmFjdG9yeSA9IG5ldyBSZW5kZXJlcnNGYWN0b3J5KGVsZW1lbnQsIF9vcHRpb25zLCBfZWxlbWVudFNpemUsIGJ1bGxldFNjcmVlbkV2ZW50VHJpZ2dlcik7XG4gICAgICAgIGxldCBfcmVuZGVyZXIgPSByZW5kZXJlcnNGYWN0b3J5LmdldEdlbmVyYWxSZW5kZXJlcihyZW5kZXJNb2RlKTsgLy/lrp7kvovljJbmuLLmn5PlmahcbiAgICAgICAgc2V0SW50ZXJ2YWwoc2V0U2l6ZSwgMTAwKTtcblxuICAgICAgICAvL+WFrOWFseWHveaVsFxuICAgICAgICAvKipcbiAgICAgICAgICog6K6+572u5oiW6I635Y+W5YWo5bGA6YCJ6aG5XG4gICAgICAgICAqIEBwcml2YXRlXG4gICAgICAgICAqKi9cbiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICdvcHRpb25zJywge1xuICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIEhlbHBlci5jbG9uZShfb3B0aW9ucyk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiAob3B0aW9ucykge1xuICAgICAgICAgICAgICAgIF9vcHRpb25zID0gSGVscGVyLnNldFZhbHVlcyhvcHRpb25zLCBfb3B0aW9ucywgX29wdGlvbnNUeXBlLCBmYWxzZSk7IC8v6K6+572u6buY6K6k5YC8XG4gICAgICAgICAgICAgICAgaWYgKF9vbGRPcGFjaXR5ICE9IF9vcHRpb25zLm9wYWNpdHkpIHtcbiAgICAgICAgICAgICAgICAgICAgX29sZE9wYWNpdHkgPSBfb3B0aW9ucy5vcGFjaXR5O1xuICAgICAgICAgICAgICAgICAgICBfcmVuZGVyZXIuc2V0T3BhY2l0eSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIOa3u+WKoOW8ueW5leWIsOW8ueW5leWIl+ihqOOAglxuICAgICAgICAgKiBAZGVzY3JpcHRpb24g5re75Yqg5by55bmV5Yiw5by55bmV5YiX6KGo44CC55Sx5LqO5by55bmV5Zyo5bGP5bmV5LiK5Ye6546w6L+H5ZCO77yM5by55bmV5byV5pOO5bCG5LuO5YiX6KGo5Lit5b275bqV5Yig6Zmk5q2k5by55bmV44CC5omA5Lul77yM5Zyo5pS55Y+Y5pKt5pS+6L+b5bqm5pe277yM5Y+v6IO96ZyA6KaB5YWIW+a4heepuuW8ueW5leWIl+ihqF17QGxpbmsgb3BlbkJTRS5CdWxsZXRTY3JlZW5FbmdpbmUjY2xlYW5CdWxsZXRTY3JlZW5MaXN0fe+8jOeEtuWQjumHjeaWsOWKoOi9veatpOaSreaUvui/m+W6puS7peWQjueahOW8ueW5leOAglxuICAgICAgICAgKiBAcGFyYW0ge29wZW5CU0V+U3BlY2lhbEJ1bGxldFNjcmVlbn0gYnVsbGV0U2NyZWVuIC0g5Y2V5p2h5by55bmV5pWw5o2u77ya5LiA5LiqIHtAbGluayBvcGVuQlNFflNwZWNpYWxCdWxsZXRTY3JlZW59IOe7k+aehOOAglxuICAgICAgICAgKiBAdGhyb3dzIHtUeXBlRXJyb3J9IOS8oOWFpeeahOWPguaVsOmUmeivr+aXtuW8leWPkemUmeivr+OAguivt+WPgumYhSBNRE4gW1R5cGVFcnJvcl17QGxpbmsgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvVHlwZUVycm9yfSDjgIJcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuYWRkID0gZnVuY3Rpb24gKGJ1bGxldFNjcmVlbikge1xuICAgICAgICAgICAgX2RlZmF1bHRCdWxsZXRTY3JlZW4uc3RhcnRUaW1lID0gX29wdGlvbnMuY2xvY2soKTtcbiAgICAgICAgICAgIGJ1bGxldFNjcmVlbiA9IEhlbHBlci5zZXRWYWx1ZXMoYnVsbGV0U2NyZWVuLCBfZGVmYXVsdEJ1bGxldFNjcmVlbiwgX2J1bGxldFNjcmVlblR5cGUpOyAvL+iuvue9rum7mOiupOWAvFxuXG4gICAgICAgICAgICAvL+WIm+W7uuino+mHiuWZqOWvueixoVxuICAgICAgICAgICAgYnVsbGV0U2NyZWVuLmludGVycHJldGVyID0gbmV3IEludGVycHJldGVyKGJ1bGxldFNjcmVlbi5yZW5kZXJDb2RlLCAoaW50ZXJwcmV0ZXIsIHNjb3BlKSA9PiB7XG4gICAgICAgICAgICAgICAgaW50ZXJwcmV0ZXIuc2V0UHJvcGVydHlcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBsZXQgbmV3Tm9kZSA9IG5ldyBMaW5rZWRMaXN0Lm5vZGUoYnVsbGV0U2NyZWVuKTtcbiAgICAgICAgICAgIF9idWxsZXRTY3JlZW5CdWZmZXIuZm9yRWFjaChmdW5jdGlvbiAobm9kZSkge1xuICAgICAgICAgICAgICAgIGxldCBsYXN0QnVsbGV0U2NyZWVuID0gbm9kZS5lbGVtZW50O1xuICAgICAgICAgICAgICAgIGlmIChidWxsZXRTY3JlZW4uc3RhcnRUaW1lID4gbGFzdEJ1bGxldFNjcmVlbi5zdGFydFRpbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFkZDogeyBhZGRUb1VwOiB0cnVlLCBub2RlOiBuZXdOb2RlIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICBzdG9wOiB0cnVlXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSwgdHJ1ZSk7XG4gICAgICAgICAgICBpZiAobmV3Tm9kZS5saW5rZWRMaXN0ID09PSBudWxsKSBfYnVsbGV0U2NyZWVuQnVmZmVyLnB1c2gobmV3Tm9kZSwgZmFsc2UpO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiDlvIDlp4vmkq3mlL7lvLnluZXjgIJcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMucGxheSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmICghX3BsYXlpbmcpIHtcbiAgICAgICAgICAgICAgICBpZiAoIV9zdGFydFRpbWUpXG4gICAgICAgICAgICAgICAgICAgIF9zdGFydFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICAgICAgICAgICAgICBpZiAoX3BhdXNlVGltZSlcbiAgICAgICAgICAgICAgICAgICAgX3N0YXJ0VGltZSArPSBfb3B0aW9ucy5jbG9jaygpIC0gX3BhdXNlVGltZTtcbiAgICAgICAgICAgICAgICBfbGFzdFJlZnJlc2hUaW1lID0gbnVsbDtcbiAgICAgICAgICAgICAgICBfcGxheWluZyA9IHRydWU7XG4gICAgICAgICAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHJlZnJlc2gpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiDmmoLlgZzmkq3mlL7lvLnluZXjgIJcbiAgICAgICAgICogQGRlc2NyaXB0aW9uIOaaguWBnOaSreaUvuW8ueW5leOAguaaguWBnOaSreaUvuW8ueW5leaYr+aMh+W8ueW5leaSreaUvuaaguWBnO+8jOaJgOacieacquWHuueOsOeahOW8ueW5leWwhuWBnOatouWHuueOsO+8jOW3suWHuueOsOeahOW8ueW5leWBnOatoui/kOWKqO+8jOWBnOatoua2iOWkseOAglxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5wYXVzZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmIChfcGxheWluZykge1xuICAgICAgICAgICAgICAgIF9wYXVzZVRpbWUgPSBfb3B0aW9ucy5jbG9jaygpO1xuICAgICAgICAgICAgICAgIF9wbGF5aW5nID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIOa4heepuuW8ueW5lee8k+WGsuWMuuOAglxuICAgICAgICAgKiBAZGVzY3JpcHRpb24g5riF56m65by55bmV5YiX6KGo77yM5L2G5bGP5bmV5LiK5bey57uP5Ye6546w55qE5by55bmV5LiN5Lya6KKr5riF6Zmk44CCXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmNsZWFuQnVmZmVyID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgX2J1bGxldFNjcmVlbkJ1ZmZlci5jbGVhbigpO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiDmuIXnqbrlsY/luZXlhoXlrrnjgIJcbiAgICAgICAgICogQGRlc2NyaXB0aW9uIOa4heepuuWxj+W5leWGheWuueOAgua4heepuuWxj+W5leS4iuW3sue7j+WHuueOsOeahOW8ueW5le+8jOS4jeWMheaLrOW8ueW5leWIl+ihqOS4reeahOW8ueW5leOAglxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5jbGVhblNjcmVlbiA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIF9yZWFsVGltZUJ1bGxldFNjcmVlbnMuY2xlYW4oKTtcbiAgICAgICAgICAgIF9yZW5kZXJlci5jbGVhblNjcmVlbigpO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiDlgZzmraLmkq3mlL7lvLnluZXjgIJcbiAgICAgICAgICogQGRlc2NyaXB0aW9uIOWBnOatouaSreaUvuW8ueW5leOAguWBnOatouaSreaUvuW8ueW5leaYr+aMh+WBnOatouaSreaUvuW8ueW5le+8jOm7mOiupFvml7bpl7Tln7rlh4bvvIhvcHRpb25zLmNsb2Nr77yJXXtAbGluayBvcGVuQlNFfkJ1bGxldFNjcmVlblN0eWxlfeW9kumbtu+8jOW5tlvmuIXnqbrlvLnluZXliJfooahde0BsaW5rIG9wZW5CU0UuQnVsbGV0U2NyZWVuRW5naW5lI2NsZWFuQnVsbGV0U2NyZWVuTGlzdH3jgIFb5riF56m65bGP5bmV5YaF5a65XXtAbGluayBvcGVuQlNFLkJ1bGxldFNjcmVlbkVuZ2luZSNjbGVhblNjcmVlbn3jgIJcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuc3RvcCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmIChfcGxheWluZykge1xuICAgICAgICAgICAgICAgIHRoaXMucGF1c2UoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuY2xlYW5CdWZmZXIoKTtcbiAgICAgICAgICAgIHRoaXMuY2xlYW5TY3JlZW4oKTtcbiAgICAgICAgICAgIF9wYXVzZVRpbWUgPSAwO1xuICAgICAgICAgICAgX3N0YXJ0VGltZSA9IG51bGw7XG4gICAgICAgIH07XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIOiOt+WPluaIluiuvue9ruW8ueW5leWPr+ingeaAp+OAglxuICAgICAgICAgKiBAcHJpdmF0ZVxuICAgICAgICAgKi9cbiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICd2aXNpYmlsaXR5Jywge1xuICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlbmRlcmVyLmdldFZpc2liaWxpdHkoKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uICh2aXNpYmlsaXR5KSB7XG4gICAgICAgICAgICAgICAgaWYgKHZpc2liaWxpdHkpIF9yZW5kZXJlci5zaG93KCk7XG4gICAgICAgICAgICAgICAgZWxzZSBfcmVuZGVyZXIuaGlkZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICAvKipcbiAgICAgICAgICog6I635Y+W5riy5p+T5qih5byP44CCXG4gICAgICAgICAqIEBwcml2YXRlXG4gICAgICAgICAqL1xuICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgJ3JlbmRlck1vZGUnLCB7XG4gICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVuZGVyTW9kZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIOiOt+WPluaSreaUvueKtuaAgeOAglxuICAgICAgICAgKiBAcHJpdmF0ZVxuICAgICAgICAgKi9cbiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICdwbGF5U3RhdGUnLCB7XG4gICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gX3BsYXlpbmc7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAqIOiOt+WPluiwg+ivleS/oeaBr+OAglxuICAgICAgICAqIEBwcml2YXRlXG4gICAgICAgICovXG4gICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAnZGVidWdJbmZvJywge1xuICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgdGltZTogX3BsYXlpbmcgPyBfb3B0aW9ucy5jbG9jaygpIDogX3BhdXNlVGltZSxcbiAgICAgICAgICAgICAgICAgICAgcmVhbFRpbWVCdWxsZXRTY3JlZW5Db3VudDogX3JlYWxUaW1lQnVsbGV0U2NyZWVucy5sZW5ndGgsXG4gICAgICAgICAgICAgICAgICAgIGJ1ZmZlckJ1bGxldFNjcmVlbkNvdW50OiBfYnVsbGV0U2NyZWVuQnVmZmVyLmxlbmd0aCxcbiAgICAgICAgICAgICAgICAgICAgZGVsYXk6IF9kZWxheSxcbiAgICAgICAgICAgICAgICAgICAgZGVsYXlCdWxsZXRTY3JlZW5Db3VudDogX2RlbGF5QnVsbGV0U2NyZWVuQ291bnQsXG4gICAgICAgICAgICAgICAgICAgIGZwczogX3BsYXlpbmcgPyBNYXRoLmZsb29yKF9yZWZyZXNoUmF0ZSAqIDEwMDApIDogMCAvL+W4p+mikVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8v5YaF6YOo5Ye95pWwXG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIOiuvue9ruWwuuWvuFxuICAgICAgICAgKiBAcHJpdmF0ZVxuICAgICAgICAgKi9cbiAgICAgICAgZnVuY3Rpb24gc2V0U2l6ZSgpIHtcbiAgICAgICAgICAgIGxldCBkZXZpY2VQaXhlbFJhdGlvID0gSGVscGVyLmdldERldmljZVBpeGVsUmF0aW8oKTtcbiAgICAgICAgICAgIGlmIChfb2xkRGV2aWNlUGl4ZWxSYXRpbyAhPSBkZXZpY2VQaXhlbFJhdGlvIHx8XG4gICAgICAgICAgICAgICAgX29sZENsaWVudFdpZHRoICE9IGVsZW1lbnQuY2xpZW50V2lkdGggfHxcbiAgICAgICAgICAgICAgICBfb2xkQ2xpZW50SGVpZ2h0ICE9IGVsZW1lbnQuY2xpZW50SGVpZ2h0IHx8XG4gICAgICAgICAgICAgICAgX29sZFNjYWxpbmcgIT0gX29wdGlvbnMuc2NhbGluZykge1xuICAgICAgICAgICAgICAgIF9vbGRTY2FsaW5nID0gX29wdGlvbnMuc2NhbGluZztcbiAgICAgICAgICAgICAgICBfZWxlbWVudFNpemUud2lkdGggPSBlbGVtZW50LmNsaWVudFdpZHRoIC8gX29wdGlvbnMuc2NhbGluZztcbiAgICAgICAgICAgICAgICBfZWxlbWVudFNpemUuaGVpZ2h0ID0gZWxlbWVudC5jbGllbnRIZWlnaHQgLyBfb3B0aW9ucy5zY2FsaW5nO1xuICAgICAgICAgICAgICAgIF9vbGRDbGllbnRXaWR0aCA9IGVsZW1lbnQuY2xpZW50V2lkdGg7XG4gICAgICAgICAgICAgICAgX29sZENsaWVudEhlaWdodCA9IGVsZW1lbnQuY2xpZW50SGVpZ2h0O1xuICAgICAgICAgICAgICAgIF9vbGREZXZpY2VQaXhlbFJhdGlvID0gZGV2aWNlUGl4ZWxSYXRpbztcbiAgICAgICAgICAgICAgICBfcmVuZGVyZXIuc2V0U2l6ZSgpO1xuICAgICAgICAgICAgICAgIGlmICghX3BsYXlpbmcpIF9yZW5kZXJlci5kcmF3KCk7IC8v6Z2e5pKt5pS+54q25oCB5YiZ6YeN57uYXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvL0lFIEVkZ2Ug5rWP6KeI5Zmo5LiN5pSv5oyBICVjXG4gICAgICAgIGlmICghIXdpbmRvdy5BY3RpdmVYT2JqZWN0IHx8IFwiQWN0aXZlWE9iamVjdFwiIGluIHdpbmRvdyB8fCBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoXCJUcmlkZW50XCIpID4gLTEgfHxcbiAgICAgICAgICAgIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZihcIk1TSUVcIikgPiAtMSB8fCBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoXCJFZGdlXCIpID4gLTEpIGNvbnNvbGUuaW5mbyhcbiAgICAgICAgICAgICAgICBSZXNvdXJjZXMuTE9BREVEX0lORk9fSUUuZmlsbERhdGEoYnVpbGQpXG4gICAgICAgICAgICApO1xuICAgICAgICAvL090aGVyXG4gICAgICAgIGVsc2UgY29uc29sZS5pbmZvKFxuICAgICAgICAgICAgUmVzb3VyY2VzLkxPQURFRF9JTkZPLmZpbGxEYXRhKGJ1aWxkKSxcbiAgICAgICAgICAgICdmb250LXdlaWdodDpib2xkOyBjb2xvcjojMDA5OUZGOycsICcnLCAnZm9udC1zdHlsZTppdGFsaWM7JywgJydcbiAgICAgICAgKTtcbiAgICB9XG59Il0sImZpbGUiOiJlbmdpbmVzL3NwZWNpYWxFbmdpbmUuanMifQ==
